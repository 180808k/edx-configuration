---
- name: jenkins | Create jenkins group
  group: name={{ jenkins_group }} state=present

- name: jenkins | Add the jenkins user to the group
  user: name={{ jenkins_user }} append=yes group={{ jenkins_group }}

- name: jenkins | ensure .bashrc exists
  shell: touch {{ jenkins_user_home }}/.bashrc
  sudo_user: "{{ jenkins_user }}"

- name: jenkins | Create directory for builds
  file: path={{ jenkins_workspace }}
    owner={{ jenkins_user }} group={{ jenkins_group }}
    state=directory

- name: jenkins | Create .ssh directory
  file: path={{ jenkins_user_home }}/.ssh state=directory
        owner={{ jenkins_user }} group={{ jenkins_group }}

# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: jenkins | Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys

- name: jenkins | Set key permissions
  file: path={{ jenkins_user_home }}/.ssh/authorized_keys
        owner={{ jenkins_user }} group={{ jenkins_group }}
        mode=400

- name: jenkins | Install system packages
  apt: pkg=${item} update_cache=yes state=present
  with_items:
    - build-essential
    - gfortran
    - graphviz
    - libgraphviz-dev
    - libopenblas-dev
    - liblapack-dev
    - libxml2-dev
    - libgeos-dev
    - libmysqlclient-dev
    - libxslt1-dev
    - mongodb
    - npm
    - pkg-config
    - unzip
    - xml-twig-tools

- name: jenkins | Stop mongo service
  service: name=mongodb state=stopped

- name: jenkins | Configure Mongo
  template: src=mongodb_conf.j2
    dest=/etc/mongodb.conf
    owner=root
    group=root

- name: jenkins | Configure Mongo upstart script
  template: src=mongodb_upstart.j2
    dest=/etc/init/mongodb.conf
    owner=root
    group=root

- name: jenkins | Start the mongo service
  service: name=mongodb state=stopped
