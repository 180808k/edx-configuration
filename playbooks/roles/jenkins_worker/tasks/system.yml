---
- name: jenkins | Create jenkins group
  group: name={{ jenkins_group }} state=present

- name: jenkins | Add the jenkins user to the group
  user: name={{ jenkins_user }} append=yes group={{ jenkins_group }}


# We need the upstart script to create the build directory
# so that (a) it will be run when a new instance is created
# on the current EBS, and (b) it will be run as root.
- name: jenkins | Install upstart script to create build dir
  template: src=jenkins_workspace.conf.j2
    dest=/etc/init/jenkins_workspace.conf
    owner=root group=root


# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: jenkins | Create .ssh directory
  file: path={{ jenkins_user_home }}/.ssh state=directory
        owner={{ jenkins_user }} group={{ jenkins_group }}

- name: jenkins | Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys

- name: jenkins | Set key permissions
  file: path={{ jenkins_user_home }}/.ssh/authorized_keys
        owner={{ jenkins_user }} group={{ jenkins_group }}
        mode=400

- name: jenkins | Install system packages
  apt: pkg=${item} update_cache=yes state=present
  with_items:
    - ack-grep
    - build-essential
    - git
    - gfortran
    - graphviz
    - lynx-cur
    - libgraphviz-dev
    - libopenblas-dev
    - liblapack-dev
    - libxml2-dev
    - libgeos-dev
    - libmysqlclient-dev
    - libxslt1-dev
    - mongodb
    - npm
    - pkg-config
    - python2.7
    - python-pip
    - python2.7-dev
    - unzip
    - xml-twig-tools

- name: jenkins | Configure environment variables
  template: src=jenkins_env.sh.j2 dest=/usr/local/bin/jenkins_env.sh
            owner=root group=root mode=0555

- name: jenkins | ensure .bash_profile exists
  shell: touch {{ jenkins_user_home }}/.bash_profile
  sudo_user: "{{ jenkins_user }}"

- name: jenkins | ensure .bashrc exists
  shell: touch {{ jenkins_user_home }}/.bashrc
  sudo_user: "{{ jenkins_user }}"

- name: jenkins | Configure bashrc
  lineinfile: dest={{ jenkins_user_home }}/.bashrc
              regexp="source /usr/local/bin/jenkins_env.sh"
              line="source /usr/local/bin/jenkins_env.sh"


# Ensure that code executed by the worker can't be
# installed to execute on login.
- name: Set permissions on .bash_profile
  file: path="{{ jenkins_user_home }}/.bash_profile" state=file
        owner="{{ jenkins_user }}" group="{{ jenkins_group }}"
        mode=0500

- name: Set permissions on .bashrc
  file: path="{{ jenkins_user_home }}/.bashrc" state=file
        owner="{{ jenkins_user }}" group="{{ jenkins_group }}"
        mode=0500
