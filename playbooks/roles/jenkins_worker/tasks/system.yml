---
- name: common | Create jenkins group
  group: name={{ jenkins_group }} state=present

- name: jenkins | Add the jenkins user to the group
  user: name={{ jenkins_user }} append=yes groups={{ jenkins_group }}

- name: jenkins | Create .ssh directory
  file: path={{ jenkins_user_home }}/.ssh state=directory
        owner={{ jenkins_user }} group={{ jenkins_group }}

# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: jenkins | Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys

- name: jenkins | Set key permissions
  file: path={{ jenkins_user_home }}/.ssh/authorized_keys
        owner={{ jenkins_user }} group={{ jenkins_group }}
        mode=600

- name: jenkins | Create directory for builds
  file: path={{ jenkins_workspace }}
        owner={{ jenkins_user }} group={{ jenkins_group }}
        state=directory

- name: jenkins | Install system packages
  apt: pkg=${item}
  with_items:
    - npm
    - graphviz
    - npm
    - libgraphviz-dev
    - gfortran
    - libopenblas-dev
    - liblapack-dev
    - libxml2-dev
    - libgeos-dev
    - libmysqlclient-dev
    - build-essential
    - pkg-config
    - libxslt1-dev
  tags:
    - system_pkgs
