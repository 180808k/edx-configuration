---
- name: jenkins | Create jenkins group
  group: name={{ jenkins_group }} state=present

- name: jenkins | Add the jenkins user to the group
  user: name={{ jenkins_user }} append=yes group={{ jenkins_group }}

- name: jenkins | ensure .bashrc exists
  shell: touch {{ jenkins_user_home }}/.bashrc
  sudo_user: "{{ jenkins_user }}"


# We need the upstart script to create the build directory
# so that (a) it will be run when a new instance is created
# on the current EBS, and (b) it will be run as root.
- name: jenkins | Install upstart script to create build dir
  template: src=jenkins_workspace.conf.j2
    dest=/etc/init/jenkins_workspace.conf
    owner=root group=root


# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: jenkins | Create .ssh directory
  file: path={{ jenkins_user_home }}/.ssh state=directory
        owner={{ jenkins_user }} group={{ jenkins_group }}

- name: jenkins | Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys

- name: jenkins | Set key permissions
  file: path={{ jenkins_user_home }}/.ssh/authorized_keys
        owner={{ jenkins_user }} group={{ jenkins_group }}
        mode=400

- name: jenkins | Install system packages
  apt: pkg=${item} update_cache=yes state=present
  with_items:
    - build-essential
    - gfortran
    - graphviz
    - libgraphviz-dev
    - libopenblas-dev
    - liblapack-dev
    - libxml2-dev
    - libgeos-dev
    - libmysqlclient-dev
    - libxslt1-dev
    - mongodb
    - npm
    - pkg-config
    - unzip
    - xml-twig-tools


# Configure Mongo to use /mnt so we don't
# run out of disk space
- name: jenkins | Stop mongo service
  service: name=mongodb state=stopped

- name: jenkins | Configure Mongo
  template: src=mongodb_conf.j2
    dest=/etc/mongodb.conf
    owner=root
    group=root

- name: jenkins | Configure Mongo upstart script
  template: src=mongodb_upstart.j2
    dest=/etc/init/mongodb.conf
    owner=root
    group=root

- name: jenkins | Start the mongo service
  service: name=mongodb state=stopped


# Install scripts to load Python packages from S3 on startup
- name: jenkins | Install Python packages script
  copy: src="install_python_pkgs.sh" dest="/usr/local/bin/install_python_pkgs.sh"
        force=yes

- name: jenkins | Make Python packages script executable
  file: path="/usr/local/bin/install_python_pkgs.sh"
        owner=root group=root
        mode=755

- name: jenkins | Install Python packages upstart script
  template: src="python_pkgs.conf.j2" dest="/etc/init/python_pkgs.conf"
